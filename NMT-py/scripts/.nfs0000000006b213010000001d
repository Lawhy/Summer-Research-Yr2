#!/usr/bin/env bash

<<'COMMENT'
This script enables easy running of preprocess-to-train-to-translate process

It takse the following arguments: {lan, ann, t_steps, l_rate} where
$lan is the language you want to train on {ar jp he ch}
$ann is the annotation class you choose {bs -+ +- ++}
$t_steps is the training steps you want to set, for en2ch 12500-13500 is enough.
$l_rate is the intial learning rate

The default working directory is: /disk/ocean/lhe/transliteration/nmt-py/models
So each time when you have a new setting to train on, you should archive the old one (by changing its name)

An example of the whole process is:
Main directory: /disk/ocean/lhe/transliteration/nmt-py/models
Suppose lan=ch, ann=+-, t_steps=12500
Script creates needed sub-directories
Woring sub-directory /disk/ocean/lhe/transliteration/nmt-py/models/ch/m+-
In m+-, there are {2 5 10 15}, four sub-directories
In each of them, there are {data infer}, two sub-directories
Script copies correspongding data from /disk/ocean/lhe/transliteration/nmt-py/data to the {data}
Script runs preprocess.py train.py and translate.py of OpenNMT-py, the translation results of development set are saved in {infer}

Please manually copy the inference scripts {wer.py cer.py err} from the Scripts directory to {infer} and run err in python3 environment
The generated wer.txt and cer-clean.txt can tell the results 


(A note of backlash usage)
The line-continuation will fail if you have whitespace (spaces or tab characters) after the backslash and before the newline 
Some detail promoted from the comments: 
the line-continuation backslash in the shell is not a special case; it is simply an example of the general rule that a backslash makes the next character literal, preventing any special effects it might have. 
In this case, the next character is a newline, and the special effect being prevented is terminating the command line. As with all other backslash escapes, there can't be anything between the backslash and the character it's quoting. 
If the next character after the backslash is a space or a tab, you just get a literal space or a tab, and there's no effect on the subsequent newline, which still terminates the command as usual
(A note of backlash usage)

COMMENT

echo "Language: {ar ch he jp}"
read lan
cd /disk/ocean/lhe/transliteration/nmt-py/data/$lan/
cat direction.txt
echo ""
echo "What model do you want? {bs -+ +- ++}"
read ann
echo "How many training steps?"
read t_steps
echo "Learning rate:"
read l_rate

# make a new main working directory after each setting is archived
mkdir /disk/ocean/lhe/transliteration/nmt-py/models
mkdir /disk/ocean/lhe/transliteration/nmt-py/models/$lan
mkdir /disk/ocean/lhe/transliteration/nmt-py/models/logs
mkdir /disk/ocean/lhe/transliteration/nmt-py/models/$lan

# Assign source and target languages
src="en"
tgt=$lan

if [ $lan = "ar" ]
then
 src=$lan
 tgt="en"
fi

tra="_tra"
dev="_dev"


if [ $ann = "bs" ]
then
 cd /disk/ocean/lhe/transliteration/nmt-py/data/$lan/
 # Create necessary directories
 mkdir /disk/ocean/lhe/transliteration/nmt-py/models/$lan/$ann
 mkdir /disk/ocean/lhe/transliteration/nmt-py/models/$lan/$ann/data
 mkdir /disk/ocean/lhe/transliteration/nmt-py/models/$lan/$ann/infer
 cp -r bs/* /disk/ocean/lhe/transliteration/nmt-py/models/$lan/$ann/data/

 # Go to the model directory
 cd /disk/ocean/lhe/transliteration/nmt-py/models/$lan/$ann

 # ---Preprocess---
 python /disk/ocean/lhe/transliteration/nmt-py/OpenNMT-py/preprocess.py \
 -train_src data/*$src$tra* -train_tgt data/*$tgt$tra* \
 -valid_src data/*$src$dev* -valid_tgt data/*$tgt$dev* \
 -save_data data/bs
 # ---Training---
 python /disk/ocean/lhe/transliteration/nmt-py/OpenNMT-py/train.py \
 -data data/bs \
 -save_model bs \
 -train_steps $t_steps \
 -seed 7 \
 -start_decay_step 8000 \
 -save_checkpoint_steps 100\
 -keep_checkpoint 10 \
 -decay_steps 1000 \
 -gpuid 1 \
 -learning_rate $l_rate \
 -log_file /disk/ocean/lhe/transliteration/nmt-py/models/logs/$lan/bs.log
 # ---Infer---
 let start=t_steps-900
 for ((j = $start; j <= $t_steps; j+=100))
 do
  python /disk/ocean/lhe/transliteration/nmt-py/OpenNMT-py/translate.py \
  -model bs_step_$j.pt \
  -src data/*$src$dev* \
  -output infer/bs_dev_$j.txt \
  -replace_unk \
  -verbose \
  -gpu 1
 done
fi

if [ $ann != "bs" ]
then
 mkdir /disk/ocean/lhe/transliteration/nmt-py/models/$lan/"m$ann"
 # Create necessary directories
 for i in {2,5,10,15}
 do
   cd /disk/ocean/lhe/transliteration/nmt-py/data/$lan/
   mkdir /disk/ocean/lhe/transliteration/nmt-py/models/$lan/"m$ann"/$i
   mkdir /disk/ocean/lhe/transliteration/nmt-py/models/$lan/"m$ann"/$i/data
   mkdir /disk/ocean/lhe/transliteration/nmt-py/models/$lan/"m$ann"/$i/infer
   # To the {2 5 10 15} cls and copy to the corresponding model dir
   dp=$i
   dp+="cls"

   # Copy data files according to the annotations (-+ +- ++)
   if [ $ann = "-+" ]
   then
   	cp -r ./bs/*$src* /disk/ocean/lhe/transliteration/nmt-py/models/$lan/"m$ann"/$i/data/  # the - part
        cp -r ./$dp/*$tgt* /disk/ocean/lhe/transliteration/nmt-py/models/$lan/"m$ann"/$i/data/ # the + part
   fi
   if [ $ann = "+-" ]
   then
	cp -r ./$dp/*$src* /disk/ocean/lhe/transliteration/nmt-py/models/$lan/"m$ann"/$i/data/ # the + part
        cp -r ./bs/*$tgt* /disk/ocean/lhe/transliteration/nmt-py/models/$lan/"m$ann"/$i/data/  # the - part
   fi

   if [ $ann = "++" ]
   then
   	cp -r ./$dp/* /disk/ocean/lhe/transliteration/nmt-py/models/$lan/"m$ann"/$i/data/ # everything +
   fi

   # Go to the model directory
   cd /disk/ocean/lhe/transliteration/nmt-py/models/$lan/"m$ann"/$i
   # --- Preprocess ---
   python /disk/ocean/lhe/transliteration/nmt-py/OpenNMT-py/preprocess.py \
   -train_src data/*$src$tra* -train_tgt data/*$tgt$tra* \
   -valid_src data/*$src$dev* -valid_tgt data/*$tgt$dev* \
   -save_data data/$i 
   # --- Training ---
   python /disk/ocean/lhe/transliteration/nmt-py/OpenNMT-py/train.py \
   -data data/$i \
   -save_model $i \
   -train_steps $t_steps \
   -seed 7 \
   -start_decay_step 8000 \
   -save_checkpoint_steps 100 \
   -keep_checkpoint 10 \
   -decay_steps 1000 \
   -learning_rate $l_rate \
   -gpuid 2 \
   -log_file /disk/ocean/lhe/transliteration/nmt-py/models/logs/$lan/$i$ann.log 
   # --- Infer ---
   let start=$t_steps-900
   development="_dev_"
   step="_step_"
   infer="_infer"
   for ((j = $start; j <= $t_steps; j+=100)); 
   do
     python /disk/ocean/lhe/transliteration/nmt-py/OpenNMT-py/translate.py \
     -model $i$step$j.pt \
     -src data/*$src$dev* \
     -output infer/$i$development$j.txt \
     -replace_unk \
     -verbose \
     -gpu 1;
   done
   echo "Finish!"
 done
fi





